# バラージ セットアップ & スコア管理 (Barrage Setup & Randomizer) 要件定義書

## 1. アプリケーション概要
ボードゲーム「バラージ (Barrage)」のゲームセットアップ（ドラフト）、結果記録、統計分析を支援するWebアプリケーション。
Streamlit (Python) で構築され、Google Sheets をデータベースとして利用する。

## 2. 機能要件

### A. データ管理
*   **Google Sheets連携**: 以下のシートを利用してデータの読み書きを行う。
    *   **マスタデータ**: `NATION_SHEET` (国家), `EXECUTIVE_SHEET` (重役), `CONTRACT_SHEET` (初期契約)
    *   **記録データ**: `SCORE_SHEET` (スコア記録), `PRESET_SHEET` (プリセット), `BALANCE_SHEET` (バランス調整履歴)
*   **画像表示**: ローカル (`images/`) の画像をBase64エンコードして表示。
*   **マスタデータのバージョン管理**:
    *   `EffectiveDate`（適用日）と `PatchNotes`（変更点）カラムによるバージョン管理。
    *   今日以前の最新レコードを自動採用。
    *   ドラフト画面で変更点（PatchNotes）を表示。

### B. 新規セットアップ (Setup)
*   **プリセット管理**:
    *   設定内容（国家・重役プール、人数、ボード）を保存・読み込み可能。
    *   デフォルトプリセットの設定（初回表示時に自動適用）。
*   **ゲーム設定**:
    *   ボード選択: 通常 / ナイル / コロラド / 4・5人用
    *   候補プール絞り込み: 国家・重役の有効/無効化。
*   **プレイヤー設定**:
    *   人数: 1〜5人
    *   ドラフト候補数: 人数と同じ / +1 / +2
    *   プレイヤー名入力: **直前のゲーム履歴から自動補完**する機能。

### C. ドラフト生成・実行 (Draft/Auction)
*   **候補生成**:
    *   プールからランダム抽出。
    *   **重み付け抽選**: 直近10ゲームでの出現回数が少ない要素を優先（出現率アップ）。
*   **ドラフト方式**:
    1.  **通常ドラフト**: ターン順に選択。
    2.  **オークション (BGA方式)**: 入札により手番とコストを決定。
*   **UI**: 候補のタイル表示、選択状態の可視化、変更点（PatchNotes）の表示。

### D. ゲーム記録・管理
*   **ゲーム開始（保存）**:
    *   ドラフト結果を `SCORE_SHEET` に追記。
    *   初期スコア計算（通常:10点、オークション:10点-入札額）。
    *   書き込み位置の自動調整（データ最終行の次に追加）。
*   **スコア入力**:
    *   未入力（FinalScore空）の最新ゲームがある場合、トップ画面に入力フォームを表示。
*   **セットアップ削除**:
    *   誤って作成したセットアップ（未入力データ）を物理削除する機能。

### E. 統計分析 (Statistics)
*   `SCORE_SHEET` の全データを可視化（Altair使用）。
*   **フィルタリング機能**:
    *   期間: 直近30日/90日/1年/全期間/**日付指定（任意範囲）**
    *   ボード、プレイヤー数、ドラフト方式
    *   **バランス調整バージョン**: 履歴から選択し、その日付以降のデータをフィルタ。
*   **分析タブ**:
    1.  **総合**: 総ゲーム数、平均スコア、スコア分布、時系列推移。
    2.  **プレイヤー**: 勝率、平均順位、スコア統計。
    3.  **プレイヤー詳細**: 選択したプレイヤーの国家・重役使用履歴、個別勝率・平均スコア。
    4.  **国家**: 使用回数、勝率、平均スコア、**プレイヤー別使用内訳**。
    5.  **重役**: 使用回数、勝率、平均スコア、**プレイヤー別使用内訳**。
    6.  **組み合わせ**: 国家×重役のペア別勝率・スコア、**対戦相手組み合わせ別の勝敗分析（マッチアップ分析）**。
    7.  **番手**: 1ラウンド目番手別の勝率、平均スコア、平均順位。
*   **UI最適化**: `@st.fragment` を使用してセレクトボックス変更時のページ全体リロードを防止。

### F. 管理者機能 (Admin)
*   **マスタデータ編集**:
    *   国家・重役の各パラメータ（Description, IconURL, PatchNotes）を編集。
    *   適用日（EffectiveDate）を指定して新バージョンとして追記保存（既存データは残る）。
*   **バランス調整履歴**:
    *   調整内容のメモを `BALANCE_SHEET` に記録。
    *   同日なら追記、別日なら新規追加。
    *   日付ベースでバージョン名を自動生成。
    *   マスタ編集と連動して自動記録、または管理者メニューから手動記録。

## 3. 非機能要件
*   **パフォーマンス**: `st.cache_data`, `st.cache_resource` 等によるAPIコール削減と高速化。
*   **堅牢性**: シートのフォーマット揺れ（空行、型不一致）に対するエラーハンドリング。
*   **UI/UX**: アイコン画像の最適化（国家50px/重役200px）、レスポンシブ対応。
