# バラージ セットアップ & スコア管理 (Barrage Setup & Randomizer) 要件定義書

## 1. アプリケーション概要
ボードゲーム「バラージ (Barrage)」のゲームセットアップ（ドラフト）、結果記録、統計分析を支援するWebアプリケーション。
Streamlit (Python) で構築され、Google Sheets をデータベースとして利用する。

## 2. 機能要件

### A. データ管理
*   **Google Sheets連携**: 以下のシートを利用してデータの読み書きを行う。
    *   **マスタデータ**: `NATION_SHEET` (国家), `EXECUTIVE_SHEET` (重役), `CONTRACT_SHEET` (初期契約)
    *   **記録データ**: `SCORE_SHEET` (スコア記録), `PRESET_SHEET` (プリセット)
*   **画像表示**: ローカル (`images/`) の画像をBase64エンコードして表示。

### B. 新規セットアップ (Setup)
*   **プリセット管理**:
    *   設定内容（国家・重役プール、人数、ボード）を保存・読み込み可能。
    *   デフォルトプリセットの設定（初回表示時に自動適用）。
*   **ゲーム設定**:
    *   ボード選択: 通常 / ナイル / コロラド / 4・5人用
    *   候補プール絞り込み: 国家・重役の有効/無効化。
*   **プレイヤー設定**:
    *   人数: 1〜5人
    *   ドラフト候補数: 人数と同じ / +1 / +2
    *   プレイヤー名入力: **直前のゲーム履歴から自動補完**する機能。

### C. ドラフト生成・実行 (Draft/Auction)
*   **候補生成**:
    *   プールからランダム抽出。
    *   **重み付け抽選**: 直近10ゲームでの出現回数が少ない要素を優先（出現率アップ）。
*   **ドラフト方式**:
    1.  **通常ドラフト**: ターン順に選択。
    2.  **オークション (BGA方式)**: 入札により手番とコストを決定。
*   **UI**: 候補のタイル表示、選択状態の可視化。

### D. ゲーム記録・管理
*   **ゲーム開始（保存）**:
    *   ドラフト結果を `SCORE_SHEET` に追記。
    *   初期スコア計算（通常:10点、オークション:10点-入札額）。
    *   書き込み位置の自動調整（データ最終行の次に追加）。
*   **スコア入力**:
    *   未入力（FinalScore空）の最新ゲームがある場合、トップ画面に入力フォームを表示。
*   **セットアップ削除**:
    *   誤って作成したセットアップ（未入力データ）を物理削除する機能。

### E. 統計分析 (Statistics)
*   `SCORE_SHEET` の全データを可視化（Altair使用）。
*   **フィルタリング機能**:
    *   期間: 直近30日/90日/1年/全期間/**日付指定（任意範囲）**
    *   ボード、プレイヤー数、ドラフト方式
*   **分析タブ**:
    1.  **総合**: 総ゲーム数、平均スコア、スコア分布、時系列推移。
    2.  **プレイヤー**: 勝率、平均順位、スコア統計。
    3.  **国家**: 使用回数、勝率、平均スコア。
    4.  **重役**: 使用回数、勝率、平均スコア。
    5.  **組み合わせ**: 国家×重役のペア別勝率・スコア。

## 3. 非機能要件
*   **パフォーマンス**: `st.cache_data` 等によるAPIコール削減と高速化。
*   **堅牢性**: シートのフォーマット揺れ（空行、型不一致）に対するエラーハンドリング。
*   **UI/UX**: アイコン画像の最適化（国家50px/重役200px）、レスポンシブ対応。
